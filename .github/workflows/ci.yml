name: Laravel CI

# 1. Kapan robot ini bekerja?
# Setiap ada PUSH atau PULL REQUEST ke branch develop atau main
on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "develop", "main" ]

# 2. Pekerjaan apa yang harus dilakukan?
jobs:
  laravel-tests:
    runs-on: ubuntu-latest # Sewa komputer Linux (Ubuntu) gratis dari GitHub

    steps:
    # A. Ambil kodingan kita dari GitHub
    - uses: actions/checkout@v4

    # B. Install PHP di komputer sewaan itu
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Sesuaikan versi PHP kamu (biasanya 8.2/8.3)
        extensions: mbstring, dom, fileinfo, sqlite3

    # C. Copy file .env (Penting!)
    - name: Copy .env
      run: php -r "file_exists('.env') || copy('.env.example', '.env');"

    # D. Install Library (Vendor)
    - name: Install Dependencies
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    # E. Generate App Key (Supaya Laravel bisa jalan)
    - name: Generate key
      run: php artisan key:generate

    # F. Buat Folder Database SQLite (Hanya formalitas, karena kita pakai :memory:)
    - name: Create Database
      run: |
        mkdir -p database
        touch database/database.sqlite

    # G. Permission Folder (Supaya bisa nulis log)
    - name: Directory Permissions
      run: chmod -R 777 storage bootstrap/cache

    # H. EKSEKUSI TES! (Momen Kebenaran)
    - name: Execute tests (Unit & Feature)
      env:
        DB_CONNECTION: sqlite
        DB_DATABASE: ":memory:"
      run: php artisan test